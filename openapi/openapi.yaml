openapi: 3.0.3
info:
  title: Speakeasy API
  version: 0.1.0

servers:
  - url: https://api.speakeasy.example.com

paths:
  /health:
    get:
      summary: Health check
      responses:
        '200':
          description: OK

  /v1/auth/register:
    post:
      summary: Register a new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                display_name:
                  type: string
                phone:
                  type: string
                  nullable: true
                email:
                  type: string
                  nullable: true
              required: [display_name]
      responses:
        '200':
          description: Registered
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                  access_token:
                    type: string

  /v1/auth/login:
    post:
      summary: Login (placeholder, details TBD)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                phone:
                  type: string
                  nullable: true
                email:
                  type: string
                  nullable: true
                code:
                  type: string
              required: [code]
      responses:
        '200':
          description: Logged in
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                  access_token:
                    type: string

  /v1/keys/upload:
    post:
      summary: Upload prekey bundle for a device
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PrekeyUpload'
      responses:
        '200':
          description: Stored

  /v1/keys/bundle/{user_id}:
    get:
      summary: Get prekey bundle(s) for a user
      parameters:
        - in: path
          name: user_id
          required: true
          schema:
            type: string
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Prekey bundle list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PrekeyBundle'

  /v1/messages/send:
    post:
      summary: Send encrypted message envelope
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessage'
      responses:
        '200':
          description: Accepted

  /v1/messages/inbox/{user_id}:
    get:
      summary: Fetch pending message envelopes for a user
      parameters:
        - in: path
          name: user_id
          required: true
          schema:
            type: string
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Pending messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MessageEnvelope'

  /v1/attachments/presign:
    post:
      summary: Create a presigned upload URL for an attachment
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                content_type:
                  type: string
                size_bytes:
                  type: integer
              required: [content_type, size_bytes]
      responses:
        '200':
          description: Presigned URL info
          content:
            application/json:
              schema:
                type: object
                properties:
                  attachment_id:
                    type: string
                  upload_url:
                    type: string
                  storage_key:
                    type: string

  /v1/attachments/url/{attachment_id}:
    get:
      summary: Get a presigned URL for downloading an encrypted attachment
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: attachment_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Presigned download URL
          content:
            application/json:
              schema:
                type: object
                properties:
                  download_url:
                    type: string

  /v1/backup/upload:
    post:
      summary: Upload encrypted backup blob
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BackupUpload'
      responses:
        '200':
          description: Stored

  /v1/backup/get:
    get:
      summary: Get encrypted backup blob for current user
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Backup blob (if exists)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackupBlob'
        '404':
          description: No backup

  # == ABUSE / SAFETY ADDITIONS ==
  /v1/users/block:
    post:
      summary: Block a user (prevent them from messaging you)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                blocked_user_id: { type: string, format: uuid }
              required: [blocked_user_id]
      responses:
        '200': { description: OK }

  /v1/reports/submit:
    post:
      summary: Submit an abuse report
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                reported_user_id: { type: string, format: uuid }
                reason: { type: string }
                decrypted_content: { type: string, description: "Optional decrypted proof" }
              required: [reported_user_id, reason]
      responses:
        '200': { description: Report received }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    PrekeyUpload:
      type: object
      properties:
        user_id:
          type: string
        device_id:
          type: string
        identity_key_ed25519_b64:
          type: string
        static_x25519_b64:
          type: string
        signed_prekey_x25519_b64:
          type: string
        signed_prekey_signature_b64:
          type: string
        one_time_prekeys_b64:
          type: array
          items:
            type: string
      required:
        - user_id
        - device_id
        - identity_key_ed25519_b64
        - static_x25519_b64
        - signed_prekey_x25519_b64
        - signed_prekey_signature_b64

    PrekeyBundle:
      type: object
      properties:
        user_id:
          type: string
        device_id:
          type: string
        identity_key_ed25519_b64:
          type: string
        static_x25519_b64:
          type: string
        signed_prekey_x25519_b64:
          type: string
        signed_prekey_signature_b64:
          type: string
        one_time_prekey_b64:
          type: string
          nullable: true

    SendMessage:
      type: object
      properties:
        to_user_id:
          type: string
        to_device_id:
          type: string
        from_device_id:
          type: string
        ciphertext_b64:
          type: string
        msg_type:
          type: string
      required:
        - to_user_id
        - to_device_id
        - from_device_id
        - ciphertext_b64
        - msg_type

    MessageEnvelope:
      type: object
      properties:
        id:
          type: string
        to_user_id:
          type: string
        to_device_id:
          type: string
        from_user_id:
          type: string
        from_device_id:
          type: string
        ciphertext_b64:
          type: string
        msg_type:
          type: string
        created_at:
          type: string
          format: date-time

    BackupUpload:
      type: object
      properties:
        blob_b64:
          type: string
        version:
          type: integer
      required:
        - blob_b64
        - version

    BackupBlob:
      type: object
      properties:
        blob_b64:
          type: string
        version:
          type: integer
